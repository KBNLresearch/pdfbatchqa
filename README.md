# PDF QUality Assessment for Digitisation batches

## What is pdfquad?

Pdfquad is a simple tool for automated quality assessment of PDF documents in digitisation batches against a user-defined technical profile. It uses [PyMuPDF](https://pymupdf.readthedocs.io/) to parse the PDF file structure and extract some relevant properties. Properties of embedded images extracted using [Pillow](https://pillow.readthedocs.io/).

These properties are serialized to a simple XML structure, which is then evaluated against [Schematron rules](http://en.wikipedia.org/wiki/Schematron) that define the expected/required technical characteristics.

## Installation

Install the software with the [pip package manager](https://en.wikipedia.org/wiki/Pip_(package_manager)):

```
pip install pdfquad
```

Then run pdfquad once:

```
pdfquad
```

Depending on your system, pdfquad will create a folder named `pdfquad` in one of the following locations: 

- For Linux, it will use the location defined by environment variable `$XDG_CONFIG_HOME`. If this variable is not set, it will use the `.config` directory in the user's home folder (e.g. `/home/johan/.config/pdfquad`). Note that the `.config` directory is hidden by default.
- For Windows, it will use the `AppData\Local` folder (e.g. `C:\Users\johan\AppData\Local\pdfquad`).

The folder contains two subdirectories named `profiles` and `schemas`, which is explained below.

## Profiles

A profile is an XML file that defines how a digitisation batch is evaluated. It is made up of one or more `schema` elements that each link a file or directory naming pattern to a Schematron file. Here's an example:

```xml
<?xml version="1.0"?>

<profile>

<!-- Profile for DBNL fulltext digitization batches. Each "schema"
element links a search pattern to a corresponding schema

- Value for "type" is either "fileName or "parentDirName"
- Value for "match" is either "is", "startswith" or "endswith"
-->

<schema type="parentDirName" match="endswith" pattern="i-85">pdf-dbnl-85.sch</schema>
<schema type="parentDirName" match="endswith" pattern="i-50">pdf-dbnl-50.sch</schema>

</profile>
```

Here we see two `schema` elements. Each element refers to a Schematron file (explained in the next section). The values of the `type`, `match` and `pattern` attributes define how this file is linked to file or directory names inside the batch:

- If **type** is "fileName", the matching is based on the naming of a PDF. In case of "parentDirName" the matching uses the naming of the direct parent directory of a PDF.
- The **match** attribute defines whether 



## Command-line syntax

The syntax of pdfquad is as follows:

```
usage: pdfquad [-h] [--maxpdfs MAXPDFS] [--prefixout PREFIXOUT]
               [--outdir OUTDIR] [--verbose] [--version]
               profile batchDir
```

### Positional arguments

- **profile**: this defines the validation profile file

- **batchDir**: this defines the batch directory that will be analyzed

### Optional arguments

- **--maxpdfs, -x**: this defines the maximum number of PDFs that are reported in each output XML file (default = 10)

- **--prefixout, -p**: this defines a text prefix on which the names of the output files are based (default = "pq")

- **--outdir, -o**: this defines the directory where output is written (default = current working directory from which pdfquad is launched)

- **--verbose, -b**: this tells pdfquad to report Schematron output in verbose format

- **--version, -v**: this tells pdfquad to show its version number and exit

## Example

So in the simplest case we can call *pdfquad* with the the batch directory as the only argument:

```
pdfbatch ./mybatch
```


## Configuration

The software relies on a configuration file ("pdfquad.conf"), which defines the ful paths of the wrapped tools, as well as the default values of some options. This file is automatically generated the first time you run the software. On Windows systems you will need to manually edit the file in a text editor to make it work (see below).

### Linux

On a Linux system, the configuration file is located at the following location:

```
~/.config/pdfquad/pdfquad.conf
```

By default it looks like this:

```
# settings pdfquad
profile = dbnl-fulltext.xml
prefix = pdfquad
pdfimages = pdfimages # pdfimages executable
pdfinfo = pdfinfo # pdfinfo executable
exiftool = exiftool # exiftool executable
```

In most cases *pdfquad* will work with this standard configuration.

### Windows

On Windows, the configuration file is located at:

```
C:\Users\<username>\AppData\Local\pdfquad\pdfquad.conf
```

By default it looks like this:

```
# settings pdfquad
profile = dbnl-fulltext.xml
prefix = pdfquad
pdfimages = C:\poppler-24.07.0\Library\bin\pdfimages.exe # pdfimages executable # pdfimages executable
pdfinfo = C:\poppler-24.07.0\Library\bin\pdfinfo.exe # pdfinfo executable
exiftool = C:\exiftool\exiftool.exe # exiftool executable
```

You will most likely need to modify the file paths to pdfimages, pdfinfo and exiftool according to the specific version and installation location on your system (unlike Linux, Windows has no standardized paths to executables).


## Batch structure

*pdfquad* was designed for processing digitisation batches that are delivered to the KB by external suppliers as part of the DBNL stream. For each digitised publication, these batches typically contain two PDF files:

1. A high quality PDF with images in JPEG format that are enoded at 85% JPEG quality
2. A lower quality PDF with images in JPEG format that are enoded at 50% JPEG quality

TODO: describe how we can distinguish between 1. and 2. (folder name, file name?).

## Profiles

A *profile* is an *XML*-formatted file that simply defines which schemas are used to validate the extracted properties of the high and low quality PDFs, respectively. Here's an example:

``` xml
<?xml version="1.0"?>

<profile>

<!-- Profile for DBNL full-text digitisation batches -->

<schemaLowQuality>pdf-dbnl-generic.sch</schemaLowQuality>
<schemaHighQuality>pdf-dbnl-generic.sch</schemaHighQuality>

</profile>
```

Note that each entry only contains the *name* of a schema, not its full path! All schemas are located in the *schemass* directory in the installation folder.

Also note that in the above example, the same schema is used for both low and high quality PDFs!

## Available profiles

The following profiles are included by default:

| Name|Description|
| :------| :-----|
|dbnl-fulltext.xml|Profile for DBNL full-text digitisation batches|

It is possible to create custom-made profiles. Just add them to the *profiles* directory in the installation folder.

## Schemas

The quality assessment is based on a number of rules/tests that are defined a set of *Schematron* schemas. These are located in the *schemas* folder in the installation directory. In principle *any* property that is reported by *pdfimages* can be used here, and new tests can be added by editing the schemas.
 
## Available schemas

| Name|Description|
|:------| :-----|
|pdf-dbnl-generic.sch|Generic schema for DBNL full-text digitisation batches|

It is possible to create custom-made schemas. Just add them to the *schemas* directory in the installation folder.

## Overview schemas

The following tables give a general overview of the technical profiles that the current schemas are representing:

### pdf-dbnl-generic

|Parameter|Value|
|:---|:---|
|Image format|JPEG|
|Image resolution|(295, 305)|
|Number of color components|3|

## Usage examples

### List available profiles

```
pdfquad d:\myBatch mybatch -p list
```

This results in a list of all available profiles (these are stored in the installation folder's *profiles* directory):

```
Available profiles:

dbnl-fulltext.xml
```

TODO: update remaining documentation.

<!--
This will result in the creation of 2 output files:

- `mybatch_status.csv` (status output file)
- `mybatch_failed.txt` (detailed output on images that failed quality asessment)

## Status output file

This is a comma-separated file with the assessment status of each analysed image. The assessment status is either *pass* (passed all tests) or *fail* (failed one or more tests). Here's an example:

    F:\test\access\MMKB03_000004896_00015_access.jp2,pass
    F:\test\access\MMKB03_000004896_00115_access.jp2,pass
    F:\test\access\MMKB03_000004896_00215_access.jp2,pass
    F:\test\targets-jp2\MMKB03_MTF_RGB_20120626_02_01.jp2,fail
    F:\test\master\MMKB03_000004896_00015_master.jp2,pass

## Failure output file

Any image that failed one or more tests are reported in the failure output file. For each failed image, it contains a full reference to the file path, followed by the specific errors. An example:

    F:\test\targets-jp2\MMKB03_MTF_RGB_20120626_02_01.jp2
    *** Schema validation errors:
    Test "layers = '11'" failed (wrong number of layers)
    Test "transformation = '5-3 reversible'" failed (wrong transformation)
    Test "comment = 'KB_MASTER_LOSSLESS_01/01/2015'" failed (wrong codestream comment string)
    ####

Entries in this file are separated by a sequence of 4 '#' characters. Note that each line here corresponds to a failed test in the schema. For images that are identified as not-valid JP2 some additional information from *jpylyzer*'s output is included as well. For example:


    F:\test\master\MMUBL07_MTF_GRAY_20121213_01_05.jp2
    *** Schema validation errors:
    Test "isValidJP2 = 'True'" failed (no valid JP2)
    *** Jpylyzer JP2 validation errors:
    Test methIsValid failed
    Test precIsValid failed
    Test approxIsValid failed
    Test foundNextTilePartOrEOC failed
    Test foundEOCMarker failed
    ####


Here, the outcome of test *isValidJP2* means that the image does not conform to the *JP2* specification. The lines following 'Jpylyzer JP2 validation errors' lists the specific errors that were reported by *jpylyzer*. The meaning of these errors can be found in the [*jpylyzer* User Manual](http://jpylyzer.openpreservation.org//userManual.html).

## Preconditions

- All images that are to be analysed have a .jp2 extension (all others are ignored!)
- *Master* images are located in a (subdirectory of a) directory called '*master*'
- *Access* images are located in a (subdirectory of a) directory called '*access*'
- *Target* images are located in a (subdirectory of a) directory called '*targets-jp2*'.
- Either of the above directories may be missing.

Other than that, the organisation of images may follow any arbitrary directory structure (*jprofile* does a recursive scan of whole directory tree of a batch).

-->

## Known limitations

- PDFs that have names containing square brackets ("[" and "]" are ignored (limitation of *Python*'s *glob* module, will be solved in the future).

## Licensing

*pdfquad* is released under the [Apache License, Version 2.0](https://www.apache.org/licenses/LICENSE-2.0).

## Useful links

- [Poppler](https://poppler.freedesktop.org/)
- [Schematron](http://en.wikipedia.org/wiki/Schematron)


